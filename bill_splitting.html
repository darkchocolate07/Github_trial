<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#000000">

    <title>Bill Splitting</title>

<!-- css start here -->
<style>

html {
  height: 100%;
  background-color: white;
}

body {
  height: 100%;
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen",
    "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue",
    sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  background-color: white;
}

code {
  font-family: source-code-pro, Menlo, Monaco, Consolas, "Courier New",
    monospace;
}

</style><style>@import url(https://fonts.googleapis.com/css2?family=Dongle:wght@700&display=swap);
</style><style>.App {
  display: grid;
  grid-template-rows: [top] 100px [center] auto;
  height: 100%;
  width: 100%;
}

.main-content-container {
  display: flex;
  justify-content: space-evenly;
  align-items: center;
  margin-top: 370px; /* Adjust the value as needed */
}

.title {
  margin: auto auto auto 635px;
}

.header-container {
    padding-top: 50;
    width: 100%;
  justify-content: space-between;
  display: flex;
  font-family: "Dongle", sans-serif;
  font-size: 30px;
}

</style><style>@import url(https://fonts.googleapis.com/css2?family=Poppins&display=swap);</style><style>.input-container {
  align-items: center;
  max-height: 40px;
  display: flex;
  flex-flow: row nowrap;
  flex-grow: 1;
}

.button-container {
  display: flex;
  justify-content: space-evenly;
  align-items: center;
}

.ge-button {
  transition: opacity 0.3s ease;
  outline: none;
  box-shadow: 0 5px 0 #d2b48c;
  cursor: pointer;
  border-radius: 8px;
  border: none;
  background-color: #fdf6e3;
  color: #39444e;
  font-size: 17px;
  font-family: "Poppins", sans-serif;
}

span {
  margin: 5px;
}

.balanceExpense {
  font-size: 18px;
  font-family: "Poppins", sans-serif;
  color: #39444e;
  margin:0;
  justify-self: center;
}

.balanceGroup {
  font-size: 18px;
  font-family: "Poppins", sans-serif;
  color: #39444e;
  margin: 8;
  justify-self: center;
}


.group-name {
  padding-top: 40px;
  margin:  auto  auto;
  font-family: "Poppins", sans-serif;
  color: #39444e;
  align-self: flex-end;

}

.group-members-title {
    padding-top: 40px;
  margin: 0px auto 0px auto;
  font-family: "Poppins", sans-serif;
  color: #39444e;
  align-self: flex-end;
}s

.settle-container input {
  padding: 1px 1px 1px 5px;
  border-radius: 7px;
  border-left: none;
  font-size: 20px;
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
  outline: none;
}

.settle-container select {
  border-radius: 7px;
  height: auto;
  padding: 1px 10px;
  font-size: 20px;
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
  width:300px;
  margin-top: 20px; /* Adjust this value as needed */

}

.group-members-container {
  width: 100px;
  height: 100px;
  box-shadow: 0 70px 100px -20px rgb(50 50 93 / 25%);
  border-radius: 8px;
  width: 30em;
  height: 35em;
  background: linear-gradient(to top, #f6f9fc 70%, #ffffff 30%);
  display: grid;
  position: relative; /* Add this line */
  grid-template-rows: [switch] 50px [title] 50px [msg] 65px [content] auto;
  
}
#paidButton {
  position: absolute; /* Position the button absolutely within its container */
  bottom: 10px; /* Adjust this value to place the button closer or further from the bottom */
  left: 50%; /* Start from the middle */
  transform: translateX(-50%); /* Center the button horizontally */
  display: none;
  /* Keep the rest of your styles as is */
}

.group-expenses-container {
  display: grid;
  grid-template-rows: [title] 110px [balance] 60px [main] auto;
  box-shadow: 0 70px 100px -20px rgb(50 50 93 / 25%);
  border-radius: 8px;
  position: relative;
  width: 30em;
  height: 35em;
  background: linear-gradient(to top, #f6f9fc 70%, #ffffff 30%);
}

#paynowNumberDisplay{
margin-top: 10px;
text-align: center;
font-family: "Poppins", sans-serif;
  font-weight: bold;
  font-size: 1.3em;

}
.toggle-header {
  margin: 0;
  font-family: "Poppins", sans-serif;
  font-size: 0.7em;
  font-weight: bold;
  align-self: end;
  text-align: center;
}
#expenseForm {
    display: flex;
    flex-direction: column; /* Aligns children vertically */
    gap: 10px; /* Spacing between each input */
    margin-top: 10px; /* Moves the form 10 pixels down */
}
.add-expense-container {
    text-align: center; /* Centers the button inside the container */
}

.center-btn {
    margin: 10px auto; /* Center button and provide some margin */
    display: block; /* Make the button a block element to apply margin auto */
}
#expenseForm input {
  transition: opacity 0.3s ease;
  outline: none;
  cursor: text; /* Use 'text' for input fields instead of 'pointer' */
  border-radius: 10px;
  border: none;
  color: #39444e;
  font-size: 18px;
  font-family: "Poppins", sans-serif;
  padding: 10px; /* Adjust padding to fit the content comfortably within the input field */
  width: calc(100% - 20px); /* Adjust width if necessary to account for padding */
  margin: 5px auto; /* Space between input fields */
  display: block;
}

.settle-container {
  flex-flow: row nowrap;
  transition: all 1s ease;
  gap: 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 90%;
  height: 50px;
  margin-left: 90;
}

.settle-container input {
  height: auto;
  width: 10px auto;
  flex-grow: 0;
}
.navbar {
    color: #45413E;
    font-weight: 600;
    height: 64px;
    background-color: #FFFFFF; /* Ensure background-color is used for clarity */
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    padding: 0% 5%;
    border-bottom: 1px solid rgba(246, 244, 244, 0.1);
    z-index: 100;
}


.navbar .logo a {
    font-size: 36px; /* Adjusted to match your previous ".logo a" style */
    font-weight: bold;
    color: #161748; /* Assuming you want to keep the logo style */
    text-decoration: none;
}

.navigation-menu {
    display: flex;
    flex-direction: row;
    flex: 1;
    justify-content: center;
    position: relative;
    top: 0;
}

.navigation-menu a {
    font-size: 16px;
    text-decoration: none;
    color: #45413E;
}

.navigation-menu > li {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.navigation-menu > li > a {

    position: relative;
    height: 64px;
    padding: 0 20px;
    display: flex; 
    align-items: center;
    justify-items: center;
    
}

/* Hover effect to match previous functionality */
/* .navigation-menu li a:hover {
    background-color: #edd7d4;
    border-radius: 8px;
} */

.navigation-menu li a:hover,
.navigation-menu li .dropdown:hover a { /* This targets the "See & Do" dropdown trigger */
    background-color: #f3f0f0; /* A specified color for hover */
    border-radius: 8px; /* Rounded corners for the hover effect */
    
}


/* Dropdown Button */
.dropbtn {
    background-color: #FFFFFF; /* Dropdown button background color */
    color: #45413E; /* Dropdown button text color */
    padding: 16px;
    font-size: 16px;
    border: none;
    cursor: pointer;
}

/* Dropdown Content (Hidden by Default) */
.dropdown-content {
    display: none;
    position: absolute;
    left: 0; /* Aligns the dropdown content left edge with the dropdown button */
    top: 100%; /* Positions the dropdown content directly below the dropdown button */
    background-color: #f9f9f9;
    min-width: 160px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    z-index: 2; /* Ensure this is above other content but consider other elements' z-index */
    border-radius: 4px; /* Optional: Adds rounded corners */
    /* margin-top: 5px; Creates a small gap between the dropdown button and the content */
}
/* The container <div> - needed to position the dropdown content */
.dropdown {
    position: relative;
    display: inline-block;
}


/* Links inside the dropdown */
.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
}

/* Change color of dropdown links on hover */
.dropdown-content a:hover {background-color: #ddd;}

/* Show the dropdown menu on hover */
.dropdown:hover .dropdown-content {display: block;}

/* Change the background color of the dropdown button when the dropdown content is shown */
.dropdown:hover .dropbtn {background-color: #ddd;}


</style>
<!-- css ends here -->
</head>
<nav class="navbar">
  <div class="logo">
      <a href="/homepage">Planify</a>
  </div>
  <ul class="navigation-menu">
      <li><a href="/homepage" class="tablink">Home</a></li>
      <li class="dropdown">
          <a href="javascript:void(0)">See & Do</a> <!-- Changed href to javascript:void(0) for dropdown -->
          <div class="dropdown-content">
              <a href="/recplaces">Recommended Places</a>
              <a href="/recplan">Recommended Plans</a>
          </div>
      </li>
      <li><a href="/makeaplan" class="tablink">Make a Plan</a></li>
      <li><a href="/Plan" class="tablink">My Plans</a></li>
      <li><a href="/billsplitting" class="tablink">Bill Splitting</a></li>
      <li><a href="/settings" class="tablink">Settings</a></li>
  </ul>
</nav>
  <body>
    <div id="root">
        <div class="App">
            <div class="main-content-container">
                <div class="group-expenses-container">
                    <h1 class="group-name">Expenses</h1>
                    <h2 class="balanceExpense">
                        You spent: 
                        <span class="balance-value user-balance-green" style="background-color: lightgrey;">
                            $0.00
                        </span>
                    </h2>
                    <div class="expense-container"><div>
                        <div class="add-expense-container">
                            <div class="button-container">
                                <button class="ge-button center-btn" id="addExpenseBtn">Add Expense</button>
                            </div>
                            <div id="expenseForm" style="display: none;">
                                <input type="text" id="expenseTitle" placeholder="Title">
                                <input type="number" id="expenseAmount" placeholder="Amount">
                                <input type="number" id="paynowNumber" placeholder="paynowNumber">
                                <button class="ge-button center-btn" id="confirmExpenseBtn" style="display: none; background-color: lightgrey; opacity: 0.2;" disabled>Confirm Expense</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="group-members-container">
                <div class="toggle-container">
                </div>
                <h1 class="group-members-title">Group Members</h1>
                <h2 class="balanceGroup">
                    Amount owe: 
                    <span class="balance-value user-balance-green" style="background-color: lightgrey;">
                        $0.00
                    </span>
                </h2>
                <div class="users-container">
                    <div class="settle-container">
                        <div>
                          <select name="users" id="usersSelect">
                          </select>  
                          <div id="paynowNumberDisplay"></div>

                          <button class="ge-button" id="paidButton" style="background-color: rgb(61, 201, 112); color: white;  margin: 20px auto;">Paid</button>
                        
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
  document.getElementById('addExpenseBtn').addEventListener('click', function() {
    document.getElementById('expenseForm').style.display = 'flex';
    let confirmBtn = document.getElementById('confirmExpenseBtn');
    confirmBtn.style.display = 'block';
    confirmBtn.disabled = true;
    confirmBtn.style.opacity = 0.2;
    confirmBtn.style.backgroundColor = "lightgrey";
    confirmBtn.style.boxShadow = "grey 0px 5px 0px";
});

document.getElementById('expenseTitle').addEventListener('input', checkFormInputs);
document.getElementById('expenseAmount').addEventListener('input', checkFormInputs);
document.getElementById('paynowNumber').addEventListener('input', checkFormInputs);


document.getElementById('confirmExpenseBtn').addEventListener('click', function() {
    var title = document.getElementById('expenseTitle').value.trim();
    var amount = parseFloat(document.getElementById('expenseAmount').value.trim());
    var paynowNumber = document.getElementById('paynowNumber').value.trim();


    const expenseData = {
        title: title,
        amount: amount,
        paynowNumber: paynowNumber
    };

    fetch('/addExpense', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(expenseData),
    })
    .then(res => res.json())
    .then(data => {
        console.log('Success:');
        updateSpendingDisplay();
    })
    .catch((error) => {
        console.error('Error:', error);
    });    
    document.getElementById('expenseForm').style.display = 'none';
    document.getElementById('expenseTitle').value = '';
    document.getElementById('expenseAmount').value = '';
    document.getElementById('paynowNumber').value = '';

    this.disabled = true;
    this.style.opacity = 0.2;
    this.style.backgroundColor = "lightgrey";
    this.style.boxShadow = "grey 0px 5px 0px";

});

document.getElementById('paidButton').addEventListener('click', function() {
    const selectedUser = document.getElementById('usersSelect').value;
    if (!selectedUser) {
        alert('No user selected.');
        return;
    }
    console.log(selectedUser,"selected");
    fetch(`/clearDebt`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ debtor: selectedUser }),
    })
    .then(response => response.json())
    .then(data => {
        console.log('Debt cleared:', data);
        document.getElementById('paidButton').style.display = 'none'; // Hide the "Paid" button
        paidButton.style.display = 'none'; // Hide the button
      paynowNumberDisplay.textContent = ''; // Clear paynowNumber display
        document.querySelector('.balanceGroup .balance-value').textContent = '$0';
        fetchAndPopulateDebts(); // Repopulate dropdown to reflect changes
        updateSpendingDisplay();
    })
    .catch(error => {
        console.error('Error clearing debt:', error);
    });

});


    
function checkFormInputs() {
    var title = document.getElementById('expenseTitle').value.trim();
    var amount = document.getElementById('expenseAmount').value.trim();
    var paynowNumber = document.getElementById('paynowNumber').value.trim();
    var confirmBtn = document.getElementById('confirmExpenseBtn');

    if (title !== '' && amount !== '' && paynowNumber !== '' ) {
        confirmBtn.disabled = false;
        confirmBtn.style.opacity = 1;
        confirmBtn.style.backgroundColor = "#fdf6e3";
        confirmBtn.style.boxShadow = " 0 5px 0 #d2b48c";
    } else {
        confirmBtn.disabled = true;
        confirmBtn.style.opacity = 0.2;
        confirmBtn.style.backgroundColor = "lightgrey";
        confirmBtn.style.boxShadow = "grey 0px 5px 0px";
    }
}

function fetchAndPopulateDebts() {
    fetch(`/getUserDebts`) // No need to append username in the query
    .then(response => response.json())
    .then(data => {
        console.log('Debt Data:', data.debt); // Log the debt data to the console

        const selectElement = document.querySelector('select[name="users"]');
        selectElement.innerHTML = ''; // Clear current options

        // Check if there are any debts
        const debtEntries = Object.entries(data.debt);
        const hasDebts = debtEntries.length > 0 && debtEntries.some(([key, value]) => value > 0);

        if (hasDebts) {
            // If there are debts, add a placeholder and then list users with debts
            const placeholderOption = document.createElement('option');
            placeholderOption.textContent = 'Select someone to pay';
            placeholderOption.value = '';
            placeholderOption.disabled = true;
            placeholderOption.selected = true;
            placeholderOption.hidden = true;
            selectElement.appendChild(placeholderOption);

            debtEntries.forEach(([key, value]) => {
                if (value > 0) { // Only add options for users who owe money
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key; // Only display the key (username)
                    selectElement.appendChild(option);
                }
            });
        } else {
            // If there are no debts, indicate that the user is "Free of debt"
            const freeOfDebtOption = document.createElement('option');
            freeOfDebtOption.textContent = 'Free of debt';
            freeOfDebtOption.value = '';
            freeOfDebtOption.selected = true;
            selectElement.appendChild(freeOfDebtOption);
            // Optionally, update the "Amount owe" text to reflect the user is free of debt
            document.querySelector('.balanceGroup .balance-value').textContent = 0;
        }
    })
    .catch(error => console.error('Error fetching debts:', error));
}


function updateSpendingDisplay() {
    fetch('/getSpending')
    .then(res => {
        if (!res.ok) {
            throw new Error('Network response was not ok');
        }
        return res.json();
    })
    .then(data => {
      console.log("no problem");
        document.querySelector('.balanceExpense .balance-value.user-balance-green').textContent = `$${data.spending.toFixed(2)}`;
    })
    .catch(error => console.error('Error updating spending display:', error));
}

function updateDebtDisplay(){
  // Assuming 'fetchAndPopulateDebts' has already been called and populated the dropdown
document.getElementById('usersSelect').addEventListener('change', function() {
    // Get the selected username from the dropdown
    const selectedUser = this.value;
    const paidButton = document.getElementById('paidButton');
    const paynowNumberDisplay = document.getElementById('paynowNumberDisplay');

    if (selectedUser) {
      paidButton.style.display = 'block'; // Show the button

      // Correctly pass the username as a query parameter
      fetch(`/getPayNowNumber?username=${encodeURIComponent(selectedUser)}`)
        .then(response => response.json())
        .then(data => {
          // Correctly extract the paynowNumber from the response data
          paynowNumberDisplay.textContent = `PayNow Number: ${data.paynowNumber}`;
        })
        .catch(error => {
          console.error('Error fetching PayNow number:', error);
          paynowNumberDisplay.textContent = 'Error fetching PayNow Number.';
        });

    } else {
      paidButton.style.display = 'none'; // Hide the button
      paynowNumberDisplay.textContent = ''; // Clear paynowNumber display
    }
    // Fetch the latest debts data (ensure this does not clear the current selection in the dropdown)
    fetch(`/getUserDebts`)
    .then(response => response.json())
    .then(data => {
        // Update the "You owe:" field with the debt amount for the selected user
        const debtAmount = data.debt[selectedUser] || 0; // Default to 0 if no debt found
        document.querySelector('.balanceGroup .balance-value').textContent = `$${debtAmount.toFixed(2)}`;
    })
    .catch(error => console.error('Error fetching debts:', error));
});

}

document.addEventListener('DOMContentLoaded', function() {
  fetchAndPopulateDebts();
  updateDebtDisplay();
    updateSpendingDisplay();
});

</script>

</body>

</html>
